<!doctype html>
<html>
    <head>
        <title>Testing the thing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1" />
        <meta name="mobile-web-app-capable" content="yes">
        <link href="style.css" type="text/css" rel="stylesheet">
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script>
            $('document').ready(function(e){
                
                var url = "https://api.projectoxford.ai/emotion/v1.0/recognize", 
                canvas = document.querySelector('canvas'), 
                apiKey = "464a63fd5a6d4a46843f063e69634d35",
                video = document.querySelector('video');
                gif = $('img');

                var responses = {anger: "Haha, look at them getting annoyed. Wonder if I could push it furthe asd asd r?",
                                 contempt: "I really need to find better people to talk to.",
                                 disgust: "I think I have to puke.",
                                 fear: "My god this person is scary. Wouldn't want to see them around kids...",
                                 happiness: "Haha, this is great. I like talking to stupid people",
                                 neutral: "This is awfully boring. Wonder if there's anyone else to talk to...",
                                 sadness: "This conversation is just making me depressed.",
                                 surprise: "That was actually interesting. Very unexpected from this person."
                                }


                // Not showing vendor prefixes. asdjhasdkjhasd
                navigator.getUserMedia({video: true, audio: true}, function(localMediaStream) {
                    video.src = window.URL.createObjectURL(localMediaStream);

                    video.onloadedmetadata = function(e) {
                      // Ready to go. Do some stuff.
                    };
                }, function(e) {
                    console.log('Reeeejected!', e);
                });
                
                //snippet to convert to binary
                var toBinary = function(canvas) {
                    var base64 = canvas.toDataURL('image/png'),
                        bin = atob(base64.replace(/^.*,/, '')),
                        buffer = new Uint8Array(bin.length);
                    for (var i = 0; i < bin.length; i++) {
                        buffer[i] = bin.charCodeAt(i);
                    }
                    return buffer;
                }


                // the function to create and send our blob
                var send = function() {
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, 320, 240);
                    var buf = toBinary(canvas);
                    
                    blob = new Blob([buf.buffer], {
                        type: 'image/png'
                    });

                    gif.addClass("visible");


                    var xhr = new XMLHttpRequest();
                    xhr.onload = function(e) {
                        var data = JSON.parse(this.response);
                        var emotion = "neutral";
                        if(data.length > 0){//faces recognized!
                            var face = data[0];
                            console.log(face);
                            ctx.strokeRect(face.faceRectangle.left, face.faceRectangle.top, face.faceRectangle.width, face.faceRectangle.height);
                            gif.removeClass("visible");
                            var maxVal = 0;
                            $.each(face.scores, function(key, value) {
                                if(key != "neutral" && value > maxVal){
                                    maxVal = value;
                                    emotion = key;
                                }
                            });
                        }
                        setTimeout(send, 3000);
                        $('#emotion').html(responses[emotion]);
                    };
                    xhr.onerror = function(e){
                        console.log(e);
                        setTimeout(send, 3000);
                    }
                    xhr.open('POST', url);
                    xhr.setRequestHeader("Content-Type", "application/octet-stream");
                    xhr.setRequestHeader("Ocp-Apim-Subscription-Key", apiKey);
                    xhr.send(blob);
                };

                $('#button').click(function(e){
                    send();
                });

                var timer = function(e){
                    setTimeout(send, 3000);
                }
                timer();

                //hide address bar

                window.scroll(0,1);
            });
        </script>
    </head>
    <body>
        <video width="320" height="240" autoplay></video>
        <canvas width="320" height="240"></canvas>
        <a id="button" href="#">Send!</a>
        <h1 id="emotion">None so far :(</h1>
        <img src="loading-gif.gif" alt="loading">
        <!-- nothing here -->
    </body>
</html>
